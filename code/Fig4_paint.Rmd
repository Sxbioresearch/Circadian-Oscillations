---
title: "Fig4_new"
output: html_document
date: "2025-11-18"
---

```{r setup, include=FALSE}
path <- 'F:/C/OP_analysis/Fig_paint/Fig4/Fig4_new'
knitr::opts_chunk$set(echo = TRUE,
                      tidy=TRUE,
                      error = T)
knitr::opts_knit$set(root.dir= path)
```

```{r}
##The phenotype prediction results for all species see in phenotype_all/Table S5 
```


```{r}
###Fig4A
###heatmap
OP_heatmap_rhythem <- read.table("heatmap_rhythem_filter.csv",header=T,row.names=1,sep = ",",stringsAsFactors = FALSE,check.names = F)
OP_heatmap_rhythem <- OP_heatmap_rhythem[, colSums(OP_heatmap_rhythem != 0) > 0, drop = FALSE]
OP_heatmap_paint <- as.data.frame(t(OP_heatmap_rhythem))
#Row and column annotation information
annotation_row <- read.table("OP_anno_phenotype_rhythem.csv",header = T,sep = ",",row.names = 1,stringsAsFactors = FALSE)
annotation_col <- read.table("OP_anno_taxa_rhythem.csv",header = T,sep = ",",row.names = 1,stringsAsFactors = FALSE)
annotation_col <- annotation_col[, -1, drop = FALSE]
library(pheatmap)
a <- rownames(annotation_row)
b <- rev(a)
OP_heatmap_paint <- OP_heatmap_paint[order(match(rownames(OP_heatmap_paint), b)), ]
c <- rownames(annotation_col)
OP_heatmap_paint <- OP_heatmap_paint[,c]
corrplot::corrplot(OP_heatmap_paint %>% as.matrix(),is.corr = F,method = "square",#col=color_map,
                   outline = F,
                 #  addCoef.col = 'black',
                   tl.pos="lt", tl.cex=0.7, tl.col="black",
                   cl.pos = "r",cl.length = 10,
                   cl.ratio = 0.1,cl.offset=1,cl.cex = 1)

####The proportion of each phenotype in each cluster
OP_phenotype_ratio <- read.table("OP_phenotype_count_fisher.csv",header = T,sep = ",",row.names = 1,stringsAsFactors = FALSE)
OP_ratio_use <- OP_phenotype_ratio[,9:12]
names(OP_ratio_use) <- c("Tcluster1","Tcluster2","Unassigned","Arrhythmic")
#OP_ratio_use$phenotype <- row.names(OP_ratio_use)
#a <- OP_ratio_use$phenotype
#b <- rev(a)
#OP_ratio_use_new <-  OP_ratio_use[rev(row.names(OP_ratio_use)), , drop = FALSE]
OP_ratio_use <- OP_ratio_use[order(match(rownames(OP_ratio_use), b)), ]

p_BH <- OP_phenotype_ratio[,33:36]
names(p_BH) <- c("Tcluster1","Tcluster2","Unassigned","Arrhythmic")
#p_BH_new <-  p_BH[rev(row.names(p_BH)), , drop = FALSE]
p_BH <- p_BH[order(match(rownames(p_BH), b)), ]
color_map <- colorRampPalette(c( "#2166AC", "#4393C3", "#92C5DE","#D1E5F0","#FFFFFF","#FDDBC7","#F4A582","#D6604D", "#B2182B","#67001F"))(100)
corrplot::corrplot(OP_ratio_use %>% as.matrix(),p.mat = p_BH %>% as.matrix(), sig.level = 0.05, insig = 'label_sig',pch.cex=1.3,is.corr = F,method = "color",col=color_map,
                   outline = T,
                 #  addCoef.col = 'black'
                   tl.pos="lt", tl.cex=0.7, tl.col="black",
                   cl.pos = "r",cl.length = 11,
                   cl.ratio = 0.35,cl.offset=1,cl.cex = 1)

```

```{r}
##Fig4B
##Feature importance
importance <- read.table("importance_paint_new.csv",header=T,row.names=1,sep = ",",stringsAsFactors = FALSE)
importance1 <- importance[,13:16]
library(ggplot2)
ggplot(importance, aes(x = reorder(rownames(importance), MeanDecreaseAccuracy) , y = MeanDecreaseAccuracy)) +
  geom_bar(stat = "identity") +
  coord_flip()+
  xlab("Phenotype")+
  ylab("Feature importance")+
  theme_bw()+
  theme(aspect.ratio = 5,
        panel.grid = element_blank() 
        )

order <- rownames(importance)
###change probability 
OP_change <- read.table("phenotype_count.csv",header=T,row.names=1,sep = ",",stringsAsFactors = FALSE,check.names = F)
OP_change_use <- OP_change[order,]
OP_change_use1 <- OP_change_use[,37:40]
names(OP_change_use1) <- c("Tcluster1","Tcluster2","Unassigned","Arrhythmic")
OP_change_use2 <- OP_change_use1+0.2
OP_change_new <- as.data.frame(log2(OP_change_use2))
#OP_change_new$cluster1_change <- replace(OP_change_new$cluster1_change, is.infinite(OP_change_new$cluster1_change), -2.2)
#OP_change_new$cluster2_change <- replace(OP_change_new$cluster2_change, is.infinite(OP_change_new$cluster2_change), -2.2)
OP_change_new2 <- round(OP_change_new, digits = 2)
color_map <- colorRampPalette(c("#053061", "#2166AC", "#4393C3", "#92C5DE","#D1E5F0","#FFFFFF","#FDDBC7","#F4A582","#D6604D", "#B2182B","#67001F"))(100)
corrplot::corrplot(OP_change_new2 %>% as.matrix(),method = "circle",outline=T,col=color_map,
                  is.corr =F,
                 col.lim =  c(-2.32, 2.84),
                 #  addCoef.col = 'black',
                   tl.pos="lt", tl.cex=0.7, tl.col="black",
                   cl.pos = "b",cl.length = 3,
                   cl.ratio = 0.05,cl.offset=1,cl.cex = 1)


```


```{r}
###RandomForest
library(UBL)
OP_phenotype_RandomForest <- read.table("OP_phenotype_RandomForest_new.csv",header=T,sep = ",",stringsAsFactors = FALSE)
OP_phenotype_RandomForest$group <- as.factor(OP_phenotype_RandomForest$group)
for (i in 2:ncol(OP_phenotype_RandomForest)) {
  OP_phenotype_RandomForest[,i] <- as.factor(OP_phenotype_RandomForest[,i])
}
table(OP_phenotype_RandomForest$group)

###SMOTE-treated dataset
set.seed(123)
OP_phenotype_RandomForest_UBL <- SmoteClassif(group ~ .,OP_phenotype_RandomForest,C.perc = list(Arrhythmic = 4.5,Tcluster1 = 24,Tcluster2=80,Unassigned=50),k = 5,dist = "Overlap")
table(OP_phenotype_RandomForest_UBL$group)


library(dplyr)
#### Use the newly generated data (SMOTE data) as the training set
train <- anti_join(OP_phenotype_RandomForest_UBL, OP_phenotype_RandomForest)
table(train$group)
library(randomForest)
library(caret)
features <- train[, -1]
target <- train$group
num_trees <- 500  
ctrl <- trainControl(method = "cv", number = 5)  
param_grid <- expand.grid(mtry = seq(1, 45, by = 1))  
# select best mtry
set.seed(123)
rf_cv <- train(features, target, method = "rf", trControl = ctrl, tuneGrid = param_grid)
print(rf_cv)
#####best mtry = 10
###RandomForest model
set.seed(123) 
rf_model_both <- randomForest(group ~ ., data = train, ntree = 500, mtry =10, importance = TRUE,proximity=TRUE)
rf_model_both

#Use the real data as the test set
test_predict <- predict(rf_model_both, OP_phenotype_RandomForest)
compare_test <- table(OP_phenotype_RandomForest$group, test_predict, dnn = c('Actual', 'Predicted'))
compare_test

#####importance p-value (significance)
library(rfPermute)
set.seed(123)
otu_rfP_all <- rfPermute(group~., data = train, importance = TRUE, ntree = 500, nrep = 1000, num.cores = 1,mtry=10)
otu_rfP_all
importance_all <- as.data.frame(importance(otu_rfP_all,scale = T))
importance_all$Arrhythmic.BH <- p.adjust(importance_all$Arrhythmic.pval,method = "BH")
importance_all$Tcluster1.BH <- p.adjust(importance_all$Tcluster1.pval,method = "BH")
importance_all$Tcluster2.BH <- p.adjust(importance_all$Tcluster2.pval,method = "BH")
importance_all$Unassigned.BH <- p.adjust(importance_all$Unassigned.pval,method = "BH")
importance_all$MeanDecreaseAccuracy.BH <- p.adjust(importance_all$MeanDecreaseAccuracy.pval,method = "BH")
importance_all$MeanDecreaseGini.BH <- p.adjust(importance_all$MeanDecreaseGini.pval,method = "BH")
write.csv(importance_all,"smote_importance_all_new.csv",quote = F)

#Top feature select
set.seed(123)
OP_all_both.cv <- replicate(5,rfcv(train[-1], train$group,cv.fold = 10,mtry=identity,scale="new",step=-1), simplify = FALSE)
OP_all_both.cv <- data.frame(sapply(OP_all_both.cv, '[[', 'error.cv'))
OP_all_both.cv$phenotype <- rownames(OP_all_both.cv)
OP_all_both.cv <- reshape2::melt(OP_all_both.cv, id = 'phenotype')
OP_all_both.cv$phenotype <- as.numeric(as.character(OP_all_both.cv$phenotype))
write.csv(OP_all_both.cv,"OP_smote_step_select_new2.csv",quote = F)
OP_fold <- read.table("OP_smote_step_select_new.csv",header=T,sep = ",",stringsAsFactors = FALSE)
library(SiZer)
model <- piecewise.linear(x=OP_all_both.cv$phenotype,y=OP_all_both.cv$value,CI=TRUE,bootstrap.samples=1000,sig.level=0.05)
model
# elbow plot of feature count
plot(model,xlab='Phenotype',ylab='Cross-validation error')

##calculate AUC
test_probs <- predict(rf_model_both, OP_phenotype_RandomForest, type = "prob")
# Multi-class AUC
roc_test <- multiclass.roc(OP_phenotype_RandomForest$group, test_probs)
print(roc_test)
roc_test$auc

```







## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
